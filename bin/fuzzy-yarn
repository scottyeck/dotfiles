#!/bin/bash

set -e

get_package_json() {
  local workspace=$1
  local package_json_dir="."
  if [[ "$workspace" != "" ]]; then
    package_json_dir="$(yarn --silent workspaces info | jq -r ".$workspace.location")"
  fi
  echo "$package_json_dir/package.json"
}

get_yarn_cmd() {
  local workspace=$1
  local yarn_cmd="yarn"
  if [[ "$workspace" != "" ]]; then
    yarn_cmd="yarn workspace $workspace"
  fi
  echo "$yarn_cmd"
}

main() {
  local workspace=$1
  local package_json="$(get_package_json $workspace)"
  local yarn_cmd="$(get_yarn_cmd $workspace)"

  # DEBUG
  # echo "workspace:    $workspace"
  # echo "package_json: $package_json"
  # echo "exec:         $exec"

  local script_name=$(cat $package_json | jq -r '.scripts' | fzf | awk '{print $1}' | sed 's/^\"//' | sed 's/\":$//')
  eval "$yarn_cmd $script_name"
}

main "$@"
