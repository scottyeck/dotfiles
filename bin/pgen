#!/bin/bash

# Constants

add="add"
remove="remove"
list="list"
install="install"
sync="sync"
prune="prune"

# Paths

bundle="$HOME/.vim/bundle"
rc="$HOME/.pathogenrc"

# Utils

getPluginName () {
    local url=$1
    name="${url##*/}"
    name="${name%.git}"
    echo $name
}

getInstalledPluginUrl () {
    local name=$1
    local url=$(cat $bundle/$name/.git/config | grep 'url' | sed 's/url =//' | sed 's/ //g')
    echo $url
}

getCurrentSha () {
    local name=$1
    echo "$( cd $bundle/$name && git rev-parse HEAD )"
}

# Commands

sync () {
    local result=""
    local name=""
    for name in $( ls $bundle ) ; do
        local url=$( getInstalledPluginUrl $name )
        local sha=$( getCurrentSha $name )
        if [[ $result = "" ]] ; then
            result=$url
        else
            result="${result}"$'\n'"${url}"
        fi
    done
    echo "${result}" > $rc
}


add () {
    local repo=$1
    local name=$( getPluginName $repo )
    if [[ -e $bundle/$name ]] ; then
        echo "Plugin '$name' is already installed"
    else
        cd $bundle
        git clone $repo || exit 1
        sync
        echo "Successfully added plugin '$name'"
    fi
}

remove () {
    local name=$1
    if [[ -e $bundle/$name ]] ; then
        rm -rf $bundle/$name
        sync
        echo "Successfully removed plugin '$name'"
    else
        echo "Plugin '$name' not found. Run 'pgen list' to view installed plugins"
    fi
}

list () {
    ls $bundle
}

install () {
    cat $rc | while read line
    do
        add $line
    done
}

prune () {
    local name=""
    for name in $( ls $bundle ) ; do
        local url=$( getInstalledPluginUrl $name )
        if ! grep -Fxq $url $rc ; then
            remove $name
        fi
    done
}

# Entry

pgen () {
    local cmd=$1
    if [ $cmd = $add ] ; then
        add "$2"
    elif [ $cmd = $remove ] ; then
        remove "$2"
    elif [ $cmd = $list ] ; then
        list
    elif [ $cmd = $install ] ; then
        install
    elif [ $cmd = $sync ] ; then
        sync
    elif [ $cmd = $prune ] ; then
        prune
    else
        echo "No command $1"
        exit 1
    fi
}

pgen "$@"

